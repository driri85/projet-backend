name: CI/CD Full Backend App (Self-Hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Clean workspace before checkout
        run: |
          sudo rm -rf $GITHUB_WORKSPACE/*
          sudo rm -rf $GITHUB_WORKSPACE/.[!.]*
        shell: bash
        continue-on-error: true

      - name: Checkout Code
        uses: actions/checkout@v4
        with: 
          clean: false

      - name: Shut down old containers
        run: docker compose down || true

      - name: Recreate network
        run: |
          docker network rm projet-backend || true
          docker network create projet-backend || true

      - name: Build & Start
        run: |
          docker compose build
          docker compose up -d

      - name: Wait for database
        run: |
          echo "Waiting for database to be ready..."
          timeout 60 bash -c 'until docker exec app-annonces-db mariadb -uroot -proot -e "SELECT 1" 2>/dev/null; do echo "Waiting..."; sleep 2; done'
          echo "Database is ready!"

      - name: Reset and run migrations
        run: |
          docker exec app-annonces-API-nodejs npx sequelize-cli db:migrate:undo:all || true
          docker exec app-annonces-API-nodejs npx sequelize-cli db:migrate

      - name: Run seeders
        run: docker exec app-annonces-API-nodejs npx sequelize-cli db:seed:all

      - name: Run tests
        run: docker exec app-annonces-API-nodejs npm test
        continue-on-error: true