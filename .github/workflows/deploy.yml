name: CI/CD Full Backend App (Self-Hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    env:
      SECRET_JWT: ${{secrets.SECRET_JWT}}
      SECRET_KEY: ${{secrets.SECRET_KEY}}
      MAILER_HOST: ${{secrets.MAILER_HOST}}
      MAILER_PORT: ${{secrets.MAILER_PORT}}
      MAILER_SECURE: ${{secrets.MAILER_SECURE}}
      MAIL_ADMIN: ${{secrets.MAIL_ADMIN}}
      MAIL_FROM: ${{secrets.MAIL_FROM}}
      MAIL_TO: ${{secrets.MAIL_TO}}
      MARIADB_DATABASE: ${{secrets.MARIADB_DATABASE}}
      MARIADB_HOST: ${{secrets.MARIADB_HOST}}
      MARIADB_PASSWORD: ${{secrets.MARIADB_PASSWORD}}
      MARIADB_PORT: ${{secrets.MARIADB_PORT}}
      MARIADB_USERNAME: ${{secrets.MARIADB_USERNAME}}
      SALT: ${{secrets.SALT}}

    steps:
      - name: Clean workspace before checkout
        run: |
          sudo rm -rf $GITHUB_WORKSPACE/*
          sudo rm -rf $GITHUB_WORKSPACE/.[!.]*
        shell: bash
        continue-on-error: true

      - name: Checkout Code
        uses: actions/checkout@v4
        with: 
          clean: false

      - name: Shut down old containers
        run: docker compose down || true

      - name: Recreate network
        run: |
          docker network rm projet-backend || true
          docker network create projet-backend || true

      - name: Build & Start (DB and infra first)
        run: |
          docker compose build
          docker compose up -d app-annonces-db app-annonces-mailhog app-annonces-adminer

      - name: Wait for database
        run: |
          echo "Waiting for database to be ready..."
          timeout 180 bash -c 'until docker exec app-annonces-db mariadb -h 127.0.0.1 -uroot -proot -e "SELECT 1" >/dev/null 2>&1; do echo "Waiting..."; sleep 3; done'
          echo "Database is ready!"

      - name: Start application service
        run: docker compose up -d app-annonces-node


      - name: Reset and run migrations
        run: |
          docker exec app-annonces-API-nodejs npx sequelize-cli db:migrate:undo:all || true
          docker exec app-annonces-API-nodejs npx sequelize-cli db:migrate

      - name: Run seeders
        run: docker exec app-annonces-API-nodejs npx sequelize-cli db:seed:all

      - name: Run tests
        run: docker exec app-annonces-API-nodejs npm test
        continue-on-error: true